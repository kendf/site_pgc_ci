<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jeu de Golf - Président Golf Club</title>

  <!-- Bootstrap 5.3.2 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome 6.4.0 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Custom Styles -->
  <link href="css/style.css" rel="stylesheet">

  <style>
    /* ============ PODIUM ============ */
    .gc-podium {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 1rem;
      padding: 2rem 0 1rem;
    }

    .gc-podium-item {
      text-align: center;
      background: #fff;
      border-radius: var(--gc-border-radius);
      box-shadow: var(--gc-card-shadow);
      padding: 1.5rem 1.25rem;
      transition: var(--gc-transition);
      flex: 0 1 220px;
      position: relative;
    }

    .gc-podium-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    .gc-podium-item.gold {
      order: 2;
      border-top: 4px solid #FFD700;
      padding-bottom: 2rem;
    }

    .gc-podium-item.silver {
      order: 1;
      border-top: 4px solid #C0C0C0;
    }

    .gc-podium-item.bronze {
      order: 3;
      border-top: 4px solid #CD7F32;
    }

    .gc-podium-medal {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: #fff;
      margin-bottom: 0.75rem;
      font-weight: 700;
    }

    .gc-podium-medal.gold { background: linear-gradient(135deg, #FFD700, #FFA500); }
    .gc-podium-medal.silver { background: linear-gradient(135deg, #C0C0C0, #A8A8A8); }
    .gc-podium-medal.bronze { background: linear-gradient(135deg, #CD7F32, #B8860B); }

    .gc-podium-name {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 1.05rem;
      color: var(--gc-dark);
      margin-bottom: 0.5rem;
    }

    .gc-podium-stat {
      font-size: 0.82rem;
      color: #777;
      margin-bottom: 0.2rem;
    }

    .gc-podium-stat strong {
      color: var(--gc-primary);
    }

    /* ============ TAB STYLES ============ */
    .gc-tabs .nav-tabs {
      border-bottom: 2px solid #e9ecef;
      gap: 0.25rem;
    }

    .gc-tabs .nav-tabs .nav-link {
      border: none;
      color: #777;
      font-weight: 500;
      padding: 0.75rem 1.25rem;
      border-radius: 8px 8px 0 0;
      transition: var(--gc-transition);
      position: relative;
    }

    .gc-tabs .nav-tabs .nav-link:hover {
      color: var(--gc-primary);
      background: rgba(26, 92, 46, 0.05);
    }

    .gc-tabs .nav-tabs .nav-link.active {
      color: var(--gc-primary);
      font-weight: 600;
      background: #fff;
      border-bottom: 3px solid var(--gc-primary);
    }

    .gc-tabs .nav-tabs .nav-link i {
      margin-right: 0.4rem;
    }

    .gc-tabs .tab-content {
      background: #fff;
      border-radius: 0 0 var(--gc-border-radius) var(--gc-border-radius);
      box-shadow: var(--gc-card-shadow);
      padding: 1.5rem;
    }

    /* ============ RANK BADGE ============ */
    .gc-rank {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
      color: #fff;
    }

    .gc-rank.rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); }
    .gc-rank.rank-2 { background: linear-gradient(135deg, #C0C0C0, #A8A8A8); }
    .gc-rank.rank-3 { background: linear-gradient(135deg, #CD7F32, #B8860B); }
    .gc-rank.rank-other { background: #e9ecef; color: #555; }

    /* ============ WEATHER BADGE ============ */
    .gc-weather {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.85rem;
      padding: 0.25rem 0.6rem;
      border-radius: 20px;
      background: #f0f0f0;
    }

    .gc-weather.sunny { background: #FFF8E1; color: #F57F17; }
    .gc-weather.cloudy { background: #ECEFF1; color: #546E7A; }
    .gc-weather.rainy { background: #E3F2FD; color: #1565C0; }
    .gc-weather.windy { background: #E8F5E9; color: #2E7D32; }

    /* ============ SUCCESS MESSAGE ============ */
    .gc-success-message {
      text-align: center;
      padding: 2rem;
      animation: fadeInUp 0.4s ease;
    }

    .gc-success-message i {
      font-size: 3rem;
      color: var(--gc-primary);
      margin-bottom: 1rem;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ============ AUTH REQUIRED OVERLAY ============ */
    .gc-auth-required {
      text-align: center;
      padding: 3rem 1rem;
    }

    .gc-auth-required i {
      font-size: 3rem;
      color: #ccc;
      margin-bottom: 1rem;
    }

    .gc-auth-required p {
      color: #888;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    /* ============ RESPONSIVE PODIUM ============ */
    @media (max-width: 768px) {
      .gc-podium {
        flex-direction: column;
        align-items: center;
      }

      .gc-podium-item {
        order: unset !important;
        width: 100%;
        max-width: 300px;
      }

      .gc-tabs .nav-tabs .nav-link {
        padding: 0.6rem 0.75rem;
        font-size: 0.85rem;
      }

      .gc-tabs .nav-tabs .nav-link span {
        display: none;
      }
    }
  </style>
</head>

<body>

  <!-- ==================== NAVBAR ==================== -->
  <nav class="navbar navbar-expand-lg gc-navbar">
    <div class="container">
      <a class="navbar-brand" href="../index.html">
        <i class="fas fa-golf-ball-tee"></i>
        Président Golf Club
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Basculer la navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="../index.html">
              <i class="fas fa-home me-1"></i> Accueil
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="reservation.html">
              <i class="fas fa-calendar-check me-1"></i> Réservation
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="client.html">
              <i class="fas fa-user me-1"></i> Mon Espace
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="jeu-golf.html">
              <i class="fas fa-flag me-1"></i> Jeu de Golf
            </a>
          </li>
        </ul>
        <div class="d-flex align-items-center gap-2">
          <span id="userGreeting" class="text-light me-2 d-none"></span>
          <a id="btnLogin" href="login.html" class="btn btn-outline-light btn-sm d-none">
            <i class="fas fa-sign-in-alt me-1"></i> Connexion
          </a>
          <button id="btnLogout" class="btn btn-outline-light btn-sm d-none" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt me-1"></i> Deconnexion
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- ==================== PAGE HEADER ==================== -->
  <div class="gc-page-header">
    <div class="container">
      <h1><i class="fas fa-golf-ball-tee me-2" style="color: var(--gc-primary);"></i> Jeu de Golf</h1>
      <p>Enregistrez vos scores et consultez le classement</p>
    </div>
  </div>

  <!-- ==================== MAIN CONTENT ==================== -->
  <div class="container mb-5">
    <div id="pageAlerts"></div>

    <!-- Tab Navigation -->
    <div class="gc-tabs">
      <ul class="nav nav-tabs" id="golfTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="classement-tab" data-bs-toggle="tab" data-bs-target="#classement" type="button" role="tab" aria-controls="classement" aria-selected="true">
            <i class="fas fa-trophy"></i> <span>Classement</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="parties-tab" data-bs-toggle="tab" data-bs-target="#parties" type="button" role="tab" aria-controls="parties" aria-selected="false">
            <i class="fas fa-list"></i> <span>Mes Parties</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="enregistrer-tab" data-bs-toggle="tab" data-bs-target="#enregistrer" type="button" role="tab" aria-controls="enregistrer" aria-selected="false">
            <i class="fas fa-plus-circle"></i> <span>Enregistrer un Score</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab" aria-controls="stats" aria-selected="false">
            <i class="fas fa-chart-bar"></i> <span>Mes Statistiques</span>
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="golfTabsContent">

        <!-- ========== TAB: CLASSEMENT ========== -->
        <div class="tab-pane fade show active" id="classement" role="tabpanel" aria-labelledby="classement-tab">
          <h4 class="mb-3"><i class="fas fa-trophy text-warning me-2"></i> Classement General</h4>
          <p class="text-muted mb-4">Decouvrez les meilleurs joueurs de notre club</p>

          <!-- Podium -->
          <div id="podiumSection" class="gc-podium mb-4">
            <!-- Dynamically generated -->
          </div>

          <!-- Full Leaderboard Table -->
          <div class="table-responsive">
            <table class="table gc-table" id="classementTable">
              <thead>
                <tr>
                  <th>Rang</th>
                  <th>Joueur</th>
                  <th>Parties jouees</th>
                  <th>Meilleur score</th>
                  <th>Score moyen</th>
                  <th>Derniere partie</th>
                </tr>
              </thead>
              <tbody id="classementBody">
                <!-- Dynamically generated -->
              </tbody>
            </table>
          </div>

          <div id="classementLoading"></div>
          <div id="classementEmpty" class="gc-empty-state d-none">
            <i class="fas fa-trophy d-block"></i>
            <p>Aucun classement disponible pour le moment.</p>
            <small class="text-muted">Soyez le premier a enregistrer un score !</small>
          </div>
        </div>

        <!-- ========== TAB: MES PARTIES ========== -->
        <div class="tab-pane fade" id="parties" role="tabpanel" aria-labelledby="parties-tab">
          <div id="partiesAuth">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h4 class="mb-0"><i class="fas fa-list text-primary me-2"></i> Mes Parties</h4>
                <p class="text-muted mb-0 mt-1">Historique de toutes vos parties de golf</p>
              </div>
              <button class="btn btn-gc-primary btn-sm" onclick="switchToTab('enregistrer-tab')">
                <i class="fas fa-plus me-1"></i> Nouvelle partie
              </button>
            </div>

            <div class="table-responsive">
              <table class="table gc-table" id="partiesTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Parcours</th>
                    <th>Trous</th>
                    <th>Score Total</th>
                    <th>Duree</th>
                    <th>Meteo</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="partiesBody">
                  <!-- Dynamically generated -->
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <nav id="partiesPagination" aria-label="Pagination des parties">
              <ul class="pagination justify-content-center">
                <!-- Dynamically generated -->
              </ul>
            </nav>

            <div id="partiesLoading"></div>
            <div id="partiesEmpty" class="gc-empty-state d-none">
              <i class="fas fa-golf-ball-tee d-block"></i>
              <p>Vous n'avez encore enregistre aucune partie.</p>
              <button class="btn btn-gc-primary mt-2" onclick="switchToTab('enregistrer-tab')">
                <i class="fas fa-plus me-1"></i> Enregistrer votre premiere partie
              </button>
            </div>
          </div>

          <div id="partiesNoAuth" class="gc-auth-required d-none">
            <i class="fas fa-lock d-block"></i>
            <p>Connectez-vous pour acceder a votre historique de parties.</p>
            <a href="login.html" class="btn btn-gc-primary">
              <i class="fas fa-sign-in-alt me-1"></i> Se connecter
            </a>
          </div>
        </div>

        <!-- ========== TAB: ENREGISTRER UN SCORE ========== -->
        <div class="tab-pane fade" id="enregistrer" role="tabpanel" aria-labelledby="enregistrer-tab">
          <div id="enregistrerAuth">
            <h4 class="mb-3"><i class="fas fa-plus-circle me-2" style="color: var(--gc-primary);"></i> Enregistrer un Score</h4>
            <p class="text-muted mb-4">Renseignez les details de votre partie de golf</p>

            <div class="gc-card">
              <div class="card-body">
                <form id="scoreForm" class="gc-form" novalidate>
                  <div class="row">
                    <!-- Score Total -->
                    <div class="col-md-6 mb-3">
                      <label for="score_total" class="form-label">
                        Score Total <span class="text-danger">*</span>
                      </label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-flag"></i></span>
                        <input type="number" class="form-control" id="score_total" name="score_total" required min="18" max="200" placeholder="72">
                      </div>
                      <div class="invalid-feedback">Veuillez entrer un score valide (entre 18 et 200).</div>
                    </div>

                    <!-- Nombre de trous -->
                    <div class="col-md-6 mb-3">
                      <label for="nombre_trous" class="form-label">
                        Nombre de trous <span class="text-danger">*</span>
                      </label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-circle-dot"></i></span>
                        <select class="form-select" id="nombre_trous" name="nombre_trous" required>
                          <option value="18" selected>18 trous</option>
                          <option value="9">9 trous</option>
                        </select>
                      </div>
                    </div>

                    <!-- Parcours -->
                    <div class="col-md-6 mb-3">
                      <label for="parcours" class="form-label">Parcours</label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-map-marked-alt"></i></span>
                        <input type="text" class="form-control" id="parcours" name="parcours" placeholder="Parcours principal">
                      </div>
                    </div>

                    <!-- Date de la partie -->
                    <div class="col-md-6 mb-3">
                      <label for="date_partie" class="form-label">Date de la partie</label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-calendar-day"></i></span>
                        <input type="date" class="form-control" id="date_partie" name="date_partie">
                      </div>
                    </div>

                    <!-- Duree -->
                    <div class="col-md-6 mb-3">
                      <label for="duree_minutes" class="form-label">Duree (minutes)</label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-clock"></i></span>
                        <input type="number" class="form-control" id="duree_minutes" name="duree_minutes" min="30" max="600" placeholder="240">
                      </div>
                    </div>

                    <!-- Meteo -->
                    <div class="col-md-6 mb-3">
                      <label for="meteo" class="form-label">Meteo</label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-cloud-sun"></i></span>
                        <select class="form-select" id="meteo" name="meteo">
                          <option value="">-- Selectionnez --</option>
                          <option value="Ensoleille">Ensoleille</option>
                          <option value="Nuageux">Nuageux</option>
                          <option value="Pluvieux">Pluvieux</option>
                          <option value="Venteux">Venteux</option>
                        </select>
                      </div>
                    </div>

                    <!-- Notes -->
                    <div class="col-12 mb-3">
                      <label for="notes" class="form-label">Notes</label>
                      <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Observations, conditions de jeu, remarques..."></textarea>
                    </div>
                  </div>

                  <!-- Submit -->
                  <div class="d-flex justify-content-end gap-2">
                    <button type="reset" class="btn btn-outline-secondary">
                      <i class="fas fa-eraser me-1"></i> Reinitialiser
                    </button>
                    <button type="submit" class="btn btn-gc-primary" id="btnSubmitScore">
                      <i class="fas fa-save me-1"></i> Enregistrer le score
                    </button>
                  </div>
                </form>

                <!-- Success Message (hidden by default) -->
                <div id="scoreSuccess" class="gc-success-message d-none">
                  <i class="fas fa-check-circle d-block"></i>
                  <h5 class="text-success mb-2">Score enregistre avec succes !</h5>
                  <p class="text-muted">Votre partie a ete ajoutee a votre historique.</p>
                  <div class="d-flex justify-content-center gap-2 mt-3">
                    <button class="btn btn-gc-primary" onclick="resetScoreForm()">
                      <i class="fas fa-plus me-1"></i> Nouvelle partie
                    </button>
                    <button class="btn btn-outline-secondary" onclick="switchToTab('parties-tab')">
                      <i class="fas fa-list me-1"></i> Voir mes parties
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="enregistrerNoAuth" class="gc-auth-required d-none">
            <i class="fas fa-lock d-block"></i>
            <p>Connectez-vous pour enregistrer vos scores.</p>
            <a href="login.html" class="btn btn-gc-primary">
              <i class="fas fa-sign-in-alt me-1"></i> Se connecter
            </a>
          </div>
        </div>

        <!-- ========== TAB: MES STATISTIQUES ========== -->
        <div class="tab-pane fade" id="stats" role="tabpanel" aria-labelledby="stats-tab">
          <div id="statsAuth">
            <h4 class="mb-3"><i class="fas fa-chart-bar me-2" style="color: var(--gc-primary);"></i> Mes Statistiques</h4>
            <p class="text-muted mb-4">Suivez votre progression et vos performances</p>

            <div id="statsLoading"></div>

            <div class="row g-3" id="statsCards">
              <!-- Parties jouees -->
              <div class="col-md-6 col-lg-3">
                <div class="gc-stat-card">
                  <div class="stat-icon bg-golf">
                    <i class="fas fa-golf-ball-tee"></i>
                  </div>
                  <div>
                    <div class="stat-value" id="statParties">--</div>
                    <div class="stat-label">Parties jouees</div>
                  </div>
                </div>
              </div>

              <!-- Meilleur score -->
              <div class="col-md-6 col-lg-3">
                <div class="gc-stat-card">
                  <div class="stat-icon bg-golf">
                    <i class="fas fa-award"></i>
                  </div>
                  <div>
                    <div class="stat-value" id="statMeilleur">--</div>
                    <div class="stat-label">Meilleur score</div>
                  </div>
                </div>
              </div>

              <!-- Score moyen -->
              <div class="col-md-6 col-lg-3">
                <div class="gc-stat-card">
                  <div class="stat-icon bg-salle">
                    <i class="fas fa-calculator"></i>
                  </div>
                  <div>
                    <div class="stat-value" id="statMoyen">--</div>
                    <div class="stat-label">Score moyen</div>
                  </div>
                </div>
              </div>

              <!-- Duree moyenne -->
              <div class="col-md-6 col-lg-3">
                <div class="gc-stat-card">
                  <div class="stat-icon bg-revenue">
                    <i class="fas fa-clock"></i>
                  </div>
                  <div>
                    <div class="stat-value" id="statDuree">--</div>
                    <div class="stat-label">Duree moyenne</div>
                  </div>
                </div>
              </div>
            </div>

            <div id="statsEmpty" class="gc-empty-state d-none mt-4">
              <i class="fas fa-chart-bar d-block"></i>
              <p>Aucune statistique disponible.</p>
              <small class="text-muted">Enregistrez votre premiere partie pour voir vos statistiques.</small>
            </div>
          </div>

          <div id="statsNoAuth" class="gc-auth-required d-none">
            <i class="fas fa-lock d-block"></i>
            <p>Connectez-vous pour consulter vos statistiques.</p>
            <a href="login.html" class="btn btn-gc-primary">
              <i class="fas fa-sign-in-alt me-1"></i> Se connecter
            </a>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ==================== DELETE CONFIRMATION MODAL ==================== -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="deleteModalLabel">
            <i class="fas fa-exclamation-triangle me-2"></i> Confirmer la suppression
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <p>Etes-vous sur de vouloir supprimer cette partie ?</p>
          <p class="text-muted small mb-0">Cette action est irreversible. Toutes les donnees associees a cette partie seront definitivement supprimees.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i> Annuler
          </button>
          <button type="button" class="btn btn-danger" id="btnConfirmDelete">
            <i class="fas fa-trash me-1"></i> Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== FOOTER ==================== -->
  <footer class="bg-dark text-light py-4 mt-5">
    <div class="container text-center">
      <p class="mb-1">
        <i class="fas fa-golf-ball-tee me-1" style="color: var(--gc-secondary);"></i>
        <strong>Président Golf Club</strong>
      </p>
      <p class="text-muted small mb-0">&copy; 2024 Président Golf Club. Tous droits reserves.</p>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- API Module -->
  <script src="js/api.js"></script>

  <script>
    'use strict';

    // ==================== STATE ====================
    let currentPartiesPage = 1;
    let totalPartiesPages = 1;
    let partieToDeleteId = null;

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', () => {
      initPage();
    });

    function initPage() {
      updateNavAuth();
      setDefaultDate();
      setupEventListeners();
      loadClassement();
    }

    // ==================== AUTH UI ====================
    function updateNavAuth() {
      const authenticated = isAuthenticated();
      const btnLogin = document.getElementById('btnLogin');
      const btnLogout = document.getElementById('btnLogout');
      const userGreeting = document.getElementById('userGreeting');

      if (authenticated) {
        btnLogin.classList.add('d-none');
        btnLogout.classList.remove('d-none');
        const userName = localStorage.getItem('user_name') || localStorage.getItem('user_email');
        if (userName) {
          userGreeting.textContent = `Bonjour, ${userName}`;
          userGreeting.classList.remove('d-none');
        }
      } else {
        btnLogin.classList.remove('d-none');
        btnLogout.classList.add('d-none');
        userGreeting.classList.add('d-none');
      }
    }

    function handleLogout() {
      removeToken();
      localStorage.removeItem('user_name');
      localStorage.removeItem('user_email');
      localStorage.removeItem('user_role');
      window.location.href = 'login.html';
    }

    function checkAuthForTab(authContentId, noAuthContentId) {
      const authContent = document.getElementById(authContentId);
      const noAuthContent = document.getElementById(noAuthContentId);

      if (isAuthenticated()) {
        authContent.classList.remove('d-none');
        noAuthContent.classList.add('d-none');
        return true;
      } else {
        authContent.classList.add('d-none');
        noAuthContent.classList.remove('d-none');
        return false;
      }
    }

    // ==================== EVENT LISTENERS ====================
    function setupEventListeners() {
      // Tab switch handlers
      document.getElementById('classement-tab').addEventListener('shown.bs.tab', () => {
        loadClassement();
      });

      document.getElementById('parties-tab').addEventListener('shown.bs.tab', () => {
        if (checkAuthForTab('partiesAuth', 'partiesNoAuth')) {
          loadMesParties(1);
        }
      });

      document.getElementById('enregistrer-tab').addEventListener('shown.bs.tab', () => {
        checkAuthForTab('enregistrerAuth', 'enregistrerNoAuth');
      });

      document.getElementById('stats-tab').addEventListener('shown.bs.tab', () => {
        if (checkAuthForTab('statsAuth', 'statsNoAuth')) {
          loadMesStats();
        }
      });

      // Score form submission
      document.getElementById('scoreForm').addEventListener('submit', handleScoreSubmit);

      // Delete confirmation
      document.getElementById('btnConfirmDelete').addEventListener('click', handleDeleteConfirm);
    }

    function setDefaultDate() {
      const dateInput = document.getElementById('date_partie');
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
      dateInput.max = today;
    }

    function switchToTab(tabId) {
      const tab = document.getElementById(tabId);
      if (tab) {
        const bsTab = new bootstrap.Tab(tab);
        bsTab.show();
      }
    }

    // ==================== CLASSEMENT ====================
    async function loadClassement() {
      const loadingEl = document.getElementById('classementLoading');
      const emptyEl = document.getElementById('classementEmpty');
      const tableEl = document.getElementById('classementTable');
      const podiumEl = document.getElementById('podiumSection');
      const bodyEl = document.getElementById('classementBody');

      showLoading(loadingEl);
      tableEl.classList.add('d-none');
      podiumEl.classList.add('d-none');
      emptyEl.classList.add('d-none');

      try {
        const response = await GolfAPI.classement(20);
        const payload = response?.data || response;
        const classement = payload || response?.classement || response;

        loadingEl.innerHTML = '';

        if (!classement || !Array.isArray(classement) || classement.length === 0) {
          emptyEl.classList.remove('d-none');
          return;
        }

        // Render podium (top 3)
        renderPodium(classement.slice(0, 3), podiumEl);
        podiumEl.classList.remove('d-none');

        // Render full table
        bodyEl.innerHTML = '';
        classement.forEach((joueur, index) => {
          const rang = index + 1;
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>
              <span class="gc-rank ${rang <= 3 ? `rank-${rang}` : 'rank-other'}">${rang}</span>
            </td>
            <td>
              <strong>${escapeHtml(joueur.nom || joueur.joueur || 'Joueur anonyme')}</strong>
            </td>
            <td>${joueur.nombre_parties ?? joueur.parties_jouees ?? joueur.nb_parties ?? 0}</td>
            <td>
              <span class="badge bg-success">${joueur.meilleur_score || joueur.best_score || '--'}</span>
            </td>
            <td>${joueur.score_moyen || joueur.avg_score ? Number(joueur.score_moyen || joueur.avg_score).toFixed(1) : '--'}</td>
            <td>${joueur.derniere_partie || joueur.last_game ? formatDate(joueur.derniere_partie || joueur.last_game) : '--'}</td>
          `;
          bodyEl.appendChild(row);
        });

        tableEl.classList.remove('d-none');
      } catch (error) {
        loadingEl.innerHTML = '';
        showAlert(document.getElementById('pageAlerts'), `Erreur lors du chargement du classement : ${error.message || 'Erreur inconnue'}`, 'danger');
      }
    }

    function renderPodium(topPlayers, container) {
      const medals = ['gold', 'silver', 'bronze'];
      const icons = ['fa-crown', 'fa-medal', 'fa-medal'];

      container.innerHTML = '';

      topPlayers.forEach((joueur, index) => {
        if (!joueur) return;

        const medal = medals[index] || 'bronze';
        const icon = icons[index] || 'fa-medal';
        const rank = index + 1;

        const item = document.createElement('div');
        item.className = `gc-podium-item ${medal}`;
        item.innerHTML = `
          <div class="gc-podium-medal ${medal}">
            <i class="fas ${icon}"></i>
          </div>
          <div class="gc-podium-name">${escapeHtml(joueur.nom || joueur.joueur || 'Joueur')}</div>
          <div class="gc-podium-stat">Meilleur : <strong>${joueur.meilleur_score || joueur.best_score || '--'}</strong></div>
          <div class="gc-podium-stat">Moyenne : <strong>${joueur.score_moyen || joueur.avg_score ? Number(joueur.score_moyen || joueur.avg_score).toFixed(1) : '--'}</strong></div>
          <div class="gc-podium-stat">Parties : <strong>${joueur.nombre_parties ?? joueur.parties_jouees ?? joueur.nb_parties ?? 0}</strong></div>
        `;

        container.appendChild(item);
      });
    }

    // ==================== MES PARTIES ====================
    async function loadMesParties(page = 1) {
      currentPartiesPage = page;

      const loadingEl = document.getElementById('partiesLoading');
      const emptyEl = document.getElementById('partiesEmpty');
      const tableEl = document.getElementById('partiesTable');
      const bodyEl = document.getElementById('partiesBody');
      const paginationEl = document.getElementById('partiesPagination');

      showLoading(loadingEl);
      tableEl.classList.add('d-none');
      emptyEl.classList.add('d-none');
      paginationEl.classList.add('d-none');

      try {
        const response = await GolfAPI.mesParties(page);
        const payload = response?.data || response || {};
        const parties = Array.isArray(payload) ? payload : (payload.data || []);
        const pagination = payload.pagination || response?.pagination || null;

        loadingEl.innerHTML = '';

        if (!parties || !Array.isArray(parties) || parties.length === 0) {
          emptyEl.classList.remove('d-none');
          return;
        }

        bodyEl.innerHTML = '';
        parties.forEach((partie) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${partie.date_partie ? formatDate(partie.date_partie) : '--'}</td>
            <td>${escapeHtml(partie.parcours || 'Non specifie')}</td>
            <td><span class="badge bg-primary">${partie.nombre_trous || 18}</span></td>
            <td><strong class="text-success">${partie.score_total || '--'}</strong></td>
            <td>${partie.duree_minutes ? formatDuration(partie.duree_minutes) : '--'}</td>
            <td>${renderWeatherBadge(partie.meteo)}</td>
            <td>
              <button class="btn btn-outline-danger btn-sm" onclick="confirmDelete('${partie.id}')" title="Supprimer cette partie">
                <i class="fas fa-trash-alt"></i>
              </button>
            </td>
          `;
          bodyEl.appendChild(row);
        });

        tableEl.classList.remove('d-none');

        // Pagination
        const totalPages = pagination?.pages || pagination?.total_pages || 1;
        if (pagination && totalPages > 1) {
          totalPartiesPages = totalPages;
          renderPagination(pagination);
          paginationEl.classList.remove('d-none');
        } else {
          paginationEl.classList.add('d-none');
        }
      } catch (error) {
        loadingEl.innerHTML = '';
        showAlert(document.getElementById('pageAlerts'), `Erreur lors du chargement des parties : ${error.message || 'Erreur inconnue'}`, 'danger');
      }
    }

    function renderPagination(pagination) {
      const container = document.querySelector('#partiesPagination .pagination');
      const currentPage = pagination.page || pagination.current_page || currentPartiesPage;
      const totalPages = pagination.pages || pagination.total_pages || 1;

      let html = '';

      // Previous button
      html += `
        <li class="page-item ${currentPage <= 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="event.preventDefault(); loadMesParties(${currentPage - 1})" aria-label="Precedent">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
      `;

      // Page numbers
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);

      if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); loadMesParties(1)">1</a></li>`;
        if (startPage > 2) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="event.preventDefault(); loadMesParties(${i})">${i}</a>
          </li>
        `;
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); loadMesParties(${totalPages})">${totalPages}</a></li>`;
      }

      // Next button
      html += `
        <li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="event.preventDefault(); loadMesParties(${currentPage + 1})" aria-label="Suivant">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      `;

      container.innerHTML = html;
    }

    // ==================== DELETE PARTIE ====================
    function confirmDelete(partieId) {
      partieToDeleteId = partieId;
      const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
      modal.show();
    }

    async function handleDeleteConfirm() {
      if (!partieToDeleteId) return;

      const btnConfirm = document.getElementById('btnConfirmDelete');
      const originalText = btnConfirm.innerHTML;
      btnConfirm.disabled = true;
      btnConfirm.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Suppression...';

      try {
        await GolfAPI.supprimerPartie(partieToDeleteId);

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
        modal.hide();

        showAlert(document.getElementById('pageAlerts'), 'Partie supprimee avec succes.', 'success');

        // Reload parties
        await loadMesParties(currentPartiesPage);
      } catch (error) {
        showAlert(document.getElementById('pageAlerts'), `Erreur lors de la suppression : ${error.message || 'Erreur inconnue'}`, 'danger');
      } finally {
        btnConfirm.disabled = false;
        btnConfirm.innerHTML = originalText;
        partieToDeleteId = null;
      }
    }

    // ==================== ENREGISTRER SCORE ====================
    async function handleScoreSubmit(event) {
      event.preventDefault();
      event.stopPropagation();

      const form = event.target;

      // Bootstrap validation
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }

      const btnSubmit = document.getElementById('btnSubmitScore');
      const originalText = btnSubmit.innerHTML;
      btnSubmit.disabled = true;
      btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Enregistrement...';

      const data = {
        score_total: parseInt(document.getElementById('score_total').value),
        nombre_trous: parseInt(document.getElementById('nombre_trous').value),
      };

      // Optional fields
      const parcours = document.getElementById('parcours').value.trim();
      if (parcours) data.parcours = parcours;

      const datePartie = document.getElementById('date_partie').value;
      if (datePartie) data.date_partie = datePartie;

      const dureeMinutes = document.getElementById('duree_minutes').value;
      if (dureeMinutes) data.duree_minutes = parseInt(dureeMinutes);

      const meteo = document.getElementById('meteo').value;
      if (meteo) data.meteo = meteo;

      const notes = document.getElementById('notes').value.trim();
      if (notes) data.notes = notes;

      try {
        await GolfAPI.enregistrerScore(data);

        // Show success message
        form.classList.add('d-none');
        document.getElementById('scoreSuccess').classList.remove('d-none');
      } catch (error) {
        showAlert(document.getElementById('pageAlerts'), `Erreur lors de l'enregistrement : ${error.message || 'Erreur inconnue'}`, 'danger');
      } finally {
        btnSubmit.disabled = false;
        btnSubmit.innerHTML = originalText;
      }
    }

    function resetScoreForm() {
      const form = document.getElementById('scoreForm');
      form.reset();
      form.classList.remove('was-validated', 'd-none');
      document.getElementById('scoreSuccess').classList.add('d-none');
      setDefaultDate();
    }

    // ==================== MES STATISTIQUES ====================
    async function loadMesStats() {
      const loadingEl = document.getElementById('statsLoading');
      const cardsEl = document.getElementById('statsCards');
      const emptyEl = document.getElementById('statsEmpty');

      showLoading(loadingEl);
      cardsEl.classList.add('d-none');
      emptyEl.classList.add('d-none');

      try {
        const response = await GolfAPI.mesStats();
        const stats = response.data || response.stats || response;
        const partiesCount = stats?.nombre_parties ?? stats?.parties_jouees ?? stats?.nb_parties ?? 0;

        loadingEl.innerHTML = '';

        if (!stats || partiesCount === 0) {
          emptyEl.classList.remove('d-none');
          cardsEl.classList.remove('d-none');
          return;
        }

        document.getElementById('statParties').textContent = partiesCount;
        document.getElementById('statMeilleur').textContent = stats.meilleur_score || stats.best_score || '--';
        document.getElementById('statMoyen').textContent = stats.score_moyen || stats.avg_score ? Number(stats.score_moyen || stats.avg_score).toFixed(1) : '--';
        document.getElementById('statDuree').textContent = stats.duree_moyenne || stats.avg_duration ? formatDuration(Number(stats.duree_moyenne || stats.avg_duration)) : '--';

        cardsEl.classList.remove('d-none');
      } catch (error) {
        loadingEl.innerHTML = '';
        showAlert(document.getElementById('pageAlerts'), `Erreur lors du chargement des statistiques : ${error.message || 'Erreur inconnue'}`, 'danger');
      }
    }

    // ==================== UTILITY FUNCTIONS ====================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDuration(minutes) {
      if (!minutes || isNaN(minutes)) return '--';
      const h = Math.floor(minutes / 60);
      const m = Math.round(minutes % 60);
      if (h === 0) return `${m} min`;
      if (m === 0) return `${h}h`;
      return `${h}h${m.toString().padStart(2, '0')}`;
    }

    function renderWeatherBadge(meteo) {
      if (!meteo) return '<span class="text-muted">--</span>';

      const weatherMap = {
        'Ensoleille': { class: 'sunny', icon: 'fa-sun' },
        'Nuageux': { class: 'cloudy', icon: 'fa-cloud' },
        'Pluvieux': { class: 'rainy', icon: 'fa-cloud-rain' },
        'Venteux': { class: 'windy', icon: 'fa-wind' },
      };

      const config = weatherMap[meteo] || { class: '', icon: 'fa-cloud-sun' };

      return `<span class="gc-weather ${config.class}"><i class="fas ${config.icon}"></i> ${escapeHtml(meteo)}</span>`;
    }
  </script>

</body>
</html>
